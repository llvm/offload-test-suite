#--- source.hlsl
[[vk::binding(0, 0)]] Texture2D<float4> Tex1 : register(t0);
[[vk::binding(1, 0)]] Texture2D<float4> Tex2 : register(t1);
[[vk::binding(3, 0)]] Texture2D<float4> Tex3 : register(t2); // 4x4 with 3 mips
[[vk::binding(2, 0)]] RWBuffer<float> Out : register(u0);

[numthreads(1, 1, 1)]
void main() {
  float width, height, levels;
  
  // Tex1 (4x8, 1 mip)
  Tex1.GetDimensions(0, width, height, levels);
  Out[0] = width;
  Out[1] = height;
  Out[2] = levels;
  
  float w, h;
  Tex1.GetDimensions(w, h);
  Out[3] = w;
  Out[4] = h;

  // Tex2 (16x32, 1 mip)
  Tex2.GetDimensions(0, width, height, levels);
  Out[5] = width;
  Out[6] = height;
  Out[7] = levels;
  
  Tex2.GetDimensions(w, h);
  Out[8] = w;
  Out[9] = h;

  // Tex3 (4x4, 3 mips)
  Tex3.GetDimensions(0, width, height, levels);
  Out[10] = width;
  Out[11] = height;
  Out[12] = levels;
}

//--- pipeline.yaml
---
Shaders:
  - Stage: Compute
    Entry: main
    DispatchSize: [1, 1, 1]

Buffers:
  - Name: Tex1
    Format: Float32
    Channels: 4
    OutputProps: { Width: 4, Height: 8, Depth: 1 }
    FillSize: 512 # 4*8*4*4

  - Name: Tex2
    Format: Float32
    Channels: 4
    OutputProps: { Width: 16, Height: 32, Depth: 1 }
    FillSize: 8192 # 16*32*4*4

  - Name: Tex3
    Format: Float32
    Channels: 4
    OutputProps: { Width: 4, Height: 4, Depth: 1, MipLevels: 3 }
    FillSize: 336 # (16 + 4 + 1) * 4 * 4 = 21 * 16 = 336

  - Name: Out
    Format: Float32
    Channels: 1
    FillSize: 52 # 13 * sizeof(float)

  - Name: Expected
    Format: Float32
    Channels: 1
    Data: [ 4.0, 8.0, 1.0, 4.0, 8.0,    # Tex1
            16.0, 32.0, 1.0, 16.0, 32.0, # Tex2
            4.0, 4.0, 3.0 ]              # Tex3

DescriptorSets:
  - Resources:
    - Name: Tex1
      Kind: Texture2D
      DirectXBinding: { Register: 0, Space: 0 }
      VulkanBinding: { Binding: 0 }
    - Name: Tex2
      Kind: Texture2D
      DirectXBinding: { Register: 1, Space: 0 }
      VulkanBinding: { Binding: 1 }
    - Name: Tex3
      Kind: Texture2D
      DirectXBinding: { Register: 2, Space: 0 }
      VulkanBinding: { Binding: 3 }
    - Name: Out
      Kind: RWBuffer
      DirectXBinding: { Register: 0, Space: 0 }
      VulkanBinding: { Binding: 2 }

Results:
  - Result: GetDimensionsTest
    Rule: BufferExact
    Actual: Out
    Expected: Expected
...
#--- end

# Unimplemented: Clang + DX: https://github.com/llvm/llvm-project/issues/101558
# Unimplemented: Clang + VK: https://github.com/llvm/llvm-project/issues/175630
# XFAIL: DirectX || Metal || Clang

# RUN: split-file %s %t
# RUN: %dxc_target -T cs_6_0 -Fo %t.o %t/source.hlsl
# RUN: %offloader %t/pipeline.yaml %t.o
