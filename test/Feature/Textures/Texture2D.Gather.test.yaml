#--- source.hlsl
[[vk::binding(0, 0)]] Texture2D<float4> Tex : register(t0);
[[vk::binding(1, 0)]] SamplerState Samp : register(s0);
[[vk::binding(3, 0)]] SamplerState SampRepeat : register(s1);
[[vk::binding(2, 0)]] RWBuffer<float4> Out : register(u0);

[numthreads(1, 1, 1)]
void main() {
  // Gather at (0.5, 0.5) on a 2x2 texture.
  // Texels used: (0,0), (1,0), (0,1), (1,1).
  // Gather returns a float4 containing the Red component of:
  // [ (0,1), (1,1), (1,0), (0,0) ]
  Out[0] = Tex.Gather(Samp, float2(0.5, 0.5));
  
  // Also test GatherRed explicitly (equivalent to Gather)
  Out[1] = Tex.GatherRed(Samp, float2(0.5, 0.5));

  // Also test GatherGreen
  Out[2] = Tex.GatherGreen(Samp, float2(0.5, 0.5));

  // Also test GatherBlue
  Out[3] = Tex.GatherBlue(Samp, float2(0.5, 0.5));

  // Also test GatherAlpha
  Out[4] = Tex.GatherAlpha(Samp, float2(0.5, 0.5));

  // Test Sampler Usage for all channels:
  float2 uv_outside = float2(1.5, 1.5);

  // Red
  Out[5] = Tex.GatherRed(Samp, uv_outside);
  Out[6] = Tex.GatherRed(SampRepeat, uv_outside);

  // Green
  Out[7] = Tex.GatherGreen(Samp, uv_outside);
  Out[8] = Tex.GatherGreen(SampRepeat, uv_outside);

  // Blue
  Out[9] = Tex.GatherBlue(Samp, uv_outside);
  Out[10] = Tex.GatherBlue(SampRepeat, uv_outside);

  // Alpha
  Out[11] = Tex.GatherAlpha(Samp, uv_outside);
  Out[12] = Tex.GatherAlpha(SampRepeat, uv_outside);
}

//--- pipeline.yaml
---
Shaders:
  - Stage: Compute
    Entry: main
    DispatchSize: [1, 1, 1]

Buffers:
  - Name: Tex
    Format: Float32
    Channels: 4
    OutputProps: { Width: 2, Height: 2, Depth: 1 }
    Data: [ 1.0, 0.0, 0.0, 1.0,  # Red   (0,0) -> R=1, G=0, B=0, A=1
            0.0, 1.0, 0.0, 1.0,  # Green (1,0) -> R=0, G=1, B=0, A=1
            0.0, 0.0, 1.0, 1.0,  # Blue  (0,1) -> R=0, G=0, B=1, A=1
            1.0, 1.0, 1.0, 0.5 ] # White (1,1) -> R=1, G=1, B=1, A=0.5

  - Name: Out
    Format: Float32
    Channels: 4
    FillSize: 208 # 13 * sizeof(float4)

  - Name: Expected
    Format: Float32
    Channels: 4
    Data: [ 0.0, 1.0, 0.0, 1.0,  # 0: Gather (Red) (0.5, 0.5)
            0.0, 1.0, 0.0, 1.0,  # 1: GatherRed (0.5, 0.5)
            0.0, 1.0, 1.0, 0.0,  # 2: GatherGreen (0.5, 0.5)
            1.0, 1.0, 0.0, 0.0,  # 3: GatherBlue (0.5, 0.5)
            1.0, 0.5, 1.0, 1.0,  # 4: GatherAlpha (0.5, 0.5)
            1.0, 1.0, 1.0, 1.0,  # 5: Red Clamp (1.5, 1.5) -> (1,1) everywhere
            0.0, 1.0, 0.0, 1.0,  # 6: Red Repeat (1.5, 1.5) -> same as (0.5, 0.5)
            1.0, 1.0, 1.0, 1.0,  # 7: Green Clamp (1.5, 1.5)
            0.0, 1.0, 1.0, 0.0,  # 8: Green Repeat (1.5, 1.5)
            1.0, 1.0, 1.0, 1.0,  # 9: Blue Clamp (1.5, 1.5)
            1.0, 1.0, 0.0, 0.0,  # 10: Blue Repeat (1.5, 1.5)
            0.5, 0.5, 0.5, 0.5,  # 11: Alpha Clamp (1.5, 1.5)
            1.0, 0.5, 1.0, 1.0 ] # 12: Alpha Repeat (1.5, 1.5)

Samplers:
  - Name: Samp
    MinFilter: Linear
    MagFilter: Linear
    Address: Clamp
  - Name: SampRepeat
    Address: Repeat

DescriptorSets:
  - Resources:
    - Name: Tex
      Kind: Texture2D
      DirectXBinding: { Register: 0, Space: 0 }
      VulkanBinding: { Binding: 0 }
    - Name: Samp
      Kind: Sampler
      DirectXBinding: { Register: 0, Space: 0 }
      VulkanBinding: { Binding: 1 }
    - Name: Out
      Kind: RWBuffer
      DirectXBinding: { Register: 0, Space: 0 }
      VulkanBinding: { Binding: 2 }
    - Name: SampRepeat
      Kind: Sampler
      DirectXBinding: { Register: 1, Space: 0 }
      VulkanBinding: { Binding: 3 }

Results:
  - Result: GatherTest
    Rule: BufferExact
    Actual: Out
    Expected: Expected
...
#--- end

# Unimplemented: Clang + DX: https://github.com/llvm/llvm-project/issues/101558
# Unimplemented: Clang + VK: https://github.com/llvm/llvm-project/issues/175630
# XFAIL: DirectX || Metal || Clang

# RUN: split-file %s %t
# RUN: %dxc_target -T cs_6_0 -Fo %t.o %t/source.hlsl
# RUN: %offloader %t/pipeline.yaml %t.o
