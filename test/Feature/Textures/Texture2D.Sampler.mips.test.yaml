#--- source.hlsl
[[vk::binding(0, 0)]] Texture2D<float4> Tex : register(t0);
[[vk::binding(1, 0)]] SamplerState MagLinearMinPoint : register(s0);
[[vk::binding(2, 0)]] SamplerState MagPointMinLinear : register(s1);
[[vk::binding(3, 0)]] RWBuffer<float4> Out : register(u0);

[numthreads(1,1,1)]
void main() {
  // Texture 2x1: [Red, Green]
  // Centers at x=0.25, x=0.75.
  // Sample at x=0.4.
  // Nearest -> Red (closer to 0.25).
  // Linear -> Lerp(Red, Green, 0.3) -> (0.7, 0.3, 0.0, 1.0).

  float2 uv = float2(0.4, 0.5);

  // 0: Mag Test (LOD -1) with Mag=Linear -> Linear Result
  Out[0] = Tex.SampleLevel(MagLinearMinPoint, uv, -1.0);

  // 1: Mag Test (LOD -1) with Mag=Point -> Nearest Result
  Out[1] = Tex.SampleLevel(MagPointMinLinear, uv, -1.0);

  // 2: Min Test (LOD 1) with Min=Point -> Nearest Result
  Out[2] = Tex.SampleLevel(MagLinearMinPoint, uv, 1.0);

  // 3: Min Test (LOD 1) with Min=Linear -> Linear Result
  Out[3] = Tex.SampleLevel(MagPointMinLinear, uv, 1.0);
}

//--- pipeline.yaml
---
Shaders:
  - Stage: Compute
    Entry: main
    DispatchSize: [1, 1, 1]

Buffers:
  - Name: Tex
    Format: Float32
    Channels: 4
    OutputProps: { Width: 2, Height: 1, Depth: 1, MipLevels: 2 }
    Data: [ 1.0, 0.0, 0.0, 1.0,  # Red
            0.0, 1.0, 0.0, 1.0,  # Green
            0.5, 0.5, 0.0, 1.0 ] # Mip 1

  - Name: Out
    Format: Float32
    Channels: 4
    FillSize: 64 # 4 * sizeof(float4)

  - Name: Expected
    Format: Float32
    Channels: 4
    Data: [ 0.7, 0.3, 0.0, 1.0,  # Linear
            1.0, 0.0, 0.0, 1.0,  # Nearest
            0.5, 0.5, 0.0, 1.0,  # Nearest (LOD 1)
            0.5, 0.5, 0.0, 1.0 ] # Linear (LOD 1)

Samplers:
  - Name: MagLinearMinPoint
    MinFilter: Nearest
    MagFilter: Linear
    Address: Clamp
  - Name: MagPointMinLinear
    MinFilter: Linear
    MagFilter: Nearest
    Address: Clamp

DescriptorSets:
  - Resources:
    - Name: Tex
      Kind: Texture2D
      DirectXBinding: { Register: 0, Space: 0 }
      VulkanBinding: { Binding: 0 }
    - Name: MagLinearMinPoint
      Kind: Sampler
      DirectXBinding: { Register: 0, Space: 0 }
      VulkanBinding: { Binding: 1 }
    - Name: MagPointMinLinear
      Kind: Sampler
      DirectXBinding: { Register: 1, Space: 0 }
      VulkanBinding: { Binding: 2 }
    - Name: Out
      Kind: RWBuffer
      DirectXBinding: { Register: 0, Space: 0 }
      VulkanBinding: { Binding: 3 }

Results:
  - Result: FilterTest
    Rule: BufferFloatEpsilon
    Actual: Out
    Expected: Expected
    Epsilon: 0.01
...
#--- end

# Unimplemented: Clang + DX: https://github.com/llvm/llvm-project/issues/101558
# XFAIL: DirectX || Metal
# XFAIL: Clang && !Vulkan

# RUN: split-file %s %t
# RUN: %dxc_target -T cs_6_0 -Fo %t.o %t/source.hlsl
# RUN: %offloader %t/pipeline.yaml %t.o
