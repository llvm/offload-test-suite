#--- source.hlsl

StructuredBuffer<half2> Min2D : register(t0);
StructuredBuffer<half4> Min3D : register(t1);
StructuredBuffer<half4> Min4D : register(t2);
StructuredBuffer<half2> Max2D : register(t3);
StructuredBuffer<half4> Max3D : register(t4);
StructuredBuffer<half4> Max4D : register(t5);
StructuredBuffer<half2> X2D : register(t6);
StructuredBuffer<half4> X3D : register(t7);
StructuredBuffer<half4> X4D : register(t8);
RWStructuredBuffer<half2> Result2D : register(u9);
RWStructuredBuffer<half4> Result3D : register(u10);
RWStructuredBuffer<half4> Result4D : register(u11);

[numthreads(1,1,1)]
void main() {
  // 2D case
  half2 result2D = smoothstep(Min2D[0], Max2D[0], X2D[0]);
  Result2D[0] = result2D;
  half2 result2D_constant = smoothstep(half2(0.75, -0.5), half2(10.5, 24.5), half2(1.0, 23.0));
  Result2D[1] = result2D_constant;

  // we should also test cases where x is below and above the min and max bounds
  // below case:
  half2 result2D_below_min = smoothstep(Min2D[1], Max2D[1], X2D[1]);
  Result2D[2] = result2D_below_min;
  // above case:
  half2 result2D_above_max = smoothstep(Min2D[2], Max2D[2], X2D[2]);
  Result2D[3] = result2D_above_max;

  // 3D case, using half4 for alignment
  half4 result3D = half4(smoothstep(Min3D[0], Max3D[0], X3D[0]));
  Result3D[0] = result3D;
  half4 result3D_constant = half4(smoothstep(half3(0.75, -0.5, 1.0), half3(10.5, 24.5, 3.0), half3(1.0, 23.0, 3.0)), 0.0);
  Result3D[1] = result3D_constant;

  // 4D case
  half4 result4D = smoothstep(Min4D[0], Max4D[0], X4D[0]);
  Result4D[0] = result4D;
  half4 result4D_constant = smoothstep(half4(0.75, -0.5, 1.0, -2.0), half4(10.5, 24.5, 3.0, -0.125), half4(1.0, 23.0, 2.5, -0.25));
  Result4D[1] = result4D_constant;
}

//--- pipeline.yaml

---
Shaders:
  - Stage: Compute
    Entry: main
    DispatchSize: [1, 1, 1]
Buffers:
  
  - Name: Min2D
    Format: Float16
    Stride: 4
    Data: [ 0x3a00, 0xb800, 0x3a00, 0xb800, 0x3a00, 0xb800, 0x0, 0x0 ]
    # 0.75, -0.5, 0.75, -0.5, 0.75, -0.5, 0.0, 0.0
  - Name: Min3D
    Format: Float16
    Stride: 8
    Data: [ 0x3a00, 0xb800, 0x3c00, 0x0]
    # 0.75, -0.5, 1.0, 0.0
  - Name: Min4D
    Format: Float16
    Stride: 8
    Data: [ 0x3a00, 0xb800, 0x3c00, 0xc000]
    # 0.75, -0.5, 1.0, -2.0
  - Name: Max2D
    Format: Float16
    Stride: 4
    Data: [ 0x4940, 0x4e20,  0x4940, 0x4e20,  0x4940, 0x4e20, 0x0, 0x0 ]
    # 10.5, 24.5, 10.5, 24.5, 10.5, 24.5, 0x0, 0x0
  - Name: Max3D
    Format: Float16
    Stride: 8
    Data: [ 0x4940, 0x4e20, 0x4200, 0x0 ]
    # 10.5, 24.5, 3.0, 0.0
  - Name: Max4D
    Format: Float16
    Stride: 8
    Data: [ 0x4940, 0x4e20, 0x4200, 0xb000 ]
    # 10.5, 24.5, 3.0, -0.125
  - Name: X2D
    Format: Float16
    Stride: 4
    Data: [ 0x3c00, 0x4dc0, 0xc580, 0xc580, 0x5004, 0x5004, 0x0, 0x0 ]
    # 1.0, 23.0, -5.5, -5.5, 32.125, 32.125, 0.0, 0.0
  - Name: X3D
    Format: Float16
    Stride: 8
    Data: [ 0x3c00, 0x4dc0, 0x4200, 0x0 ]
    # 1.0, 23.0, 3.0, 0.0
  - Name: X4D
    Format: Float16
    Stride: 8
    Data: [ 0x3c00, 0x4dc0, 0x4100, 0xb400 ]
    # 1.0, 23.0, 2.5, -0.25
  - Name: Result2D
    Format: Float16
    Stride: 4
    ZeroInitSize: 16
  - Name: ExpectedResult2D
    Format: Float16
    Stride: 4
    Data: [ 0x17F0, 0x3BEA, 0x17F0, 0x3BEA, 0x0, 0x0, 0x3C00, 0x3C00 ]
    # 0.0019378662, 0.9892578, 0.0019378662, 0.9892578, 0.0, 0.0, 1.0, 1.0
  - Name: Result3D
    Format: Float16
    Stride: 8
    ZeroInitSize: 16
  - Name: ExpectedResult3D
    Format: Float16
    Stride: 8
    Data: [ 0x17F0, 0x3BEA, 0x3C00, 0x0, 0x17F0, 0x3BEA, 0x3C00, 0x0]
    # 0.0019378662, 0.9892578, 1.0, 0.0, 0.0019378662, 0.9892578, 1.0, 0.0
  - Name: Result4D
    Format: Float16
    Stride: 8
    ZeroInitSize: 16
  - Name: ExpectedResult4D
    Format: Float16
    Stride: 8
    Data: [ 0x17F0, 0x3BEA, 0x3AC0, 0x3BE6, 0x17F0, 0x3BEA, 0x3AC0, 0x3BE6 ]
    # 0.0019378662, 0.9892578, 0.84375, 0.9873047, 0.0019378662, 0.9892578, 0.84375, 0.9873047
Results:  
  - Result: CheckResult2D
    Rule: BufferFloatULP
    ULPT: 2
    Actual: Result2D
    Expected: ExpectedResult2D
  - Result: CheckResult3D
    Rule: BufferFloatULP
    ULPT: 2
    Actual: Result3D
    Expected: ExpectedResult3D
  - Result: CheckResult4D
    Rule: BufferFloatULP
    ULPT: 2
    Actual: Result4D
    Expected: ExpectedResult4D

DescriptorSets:
  - Resources:
    - Name: Min2D
      Kind: StructuredBuffer
      DirectXBinding:
        Register: 0
        Space: 0
      VulkanBinding:
        Binding: 0
    - Name: Min3D
      Kind: StructuredBuffer
      DirectXBinding:
        Register: 1
        Space: 0
      VulkanBinding:
        Binding: 1
    - Name: Min4D
      Kind: StructuredBuffer
      DirectXBinding:
        Register: 2
        Space: 0
      VulkanBinding:
        Binding: 2
    - Name: Max2D
      Kind: StructuredBuffer
      DirectXBinding:
        Register: 3
        Space: 0
      VulkanBinding:
        Binding: 3
    - Name: Max3D
      Kind: StructuredBuffer
      DirectXBinding:
        Register: 4
        Space: 0
      VulkanBinding:
        Binding: 4
    - Name: Max4D
      Kind: StructuredBuffer
      DirectXBinding:
        Register: 5
        Space: 0
      VulkanBinding:
        Binding: 5
    - Name: X2D
      Kind: StructuredBuffer
      DirectXBinding:
        Register: 6
        Space: 0
      VulkanBinding:
        Binding: 6
    - Name: X3D
      Kind: StructuredBuffer
      DirectXBinding:
        Register: 7
        Space: 0
      VulkanBinding:
        Binding: 7
    - Name: X4D
      Kind: StructuredBuffer
      DirectXBinding:
        Register: 8
        Space: 0
      VulkanBinding:
        Binding: 8
    - Name: Result2D
      Kind: RWStructuredBuffer
      DirectXBinding:
        Register: 9
        Space: 0
      VulkanBinding:
        Binding: 9
    - Name: Result3D
      Kind: RWStructuredBuffer
      DirectXBinding:
        Register: 10
        Space: 0
      VulkanBinding:
        Binding: 10
    - Name: Result4D
      Kind: RWStructuredBuffer
      DirectXBinding:
        Register: 11
        Space: 0
      VulkanBinding:
        Binding: 11     
...
#--- end
# REQUIRES: Half

# RUN: split-file %s %t
# RUN: %dxc_target -T cs_6_5 -enable-16bit-types -Fo %t.o %t/source.hlsl
# RUN: %offloader %t/pipeline.yaml %t.o
