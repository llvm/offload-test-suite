#--- vertex.hlsl
struct VSInput {
    float4 position : POSITION;
};

struct VSOutput {
    float4 position : SV_POSITION;
    float4x4 mat : MY_MATRIX;
};

VSOutput main(VSInput input) {
    VSOutput output;
    output.position = input.position;

    output.mat = float4x4(
        1.0, 2.0, 3.0, 4.0,
        0.0, 5.0, 0.0, 0.0,
        0.0, 0.0, 6.0, 0.0,
        0.0, 0.0, 0.0, 7.0
    );

    return output;
}

#--- pixel.hlsl
struct PSInput {
    float4 position : SV_POSITION;
    float4x4 mat : MY_MATRIX;
};

RWStructuredBuffer<float> Out : register(u0);

float4 main(PSInput input) : SV_TARGET {
    Out[0] = input.mat[0][0];
    Out[1] = input.mat[0][1];
    Out[2] = input.mat[0][2];
    Out[3] = input.mat[0][3];
    Out[4] = input.mat[1][1];
    Out[5] = input.mat[2][2];
    Out[6] = input.mat[3][3];

    return float4(1.0, 0.0, 0.0, 1.0);
}

#--- pipeline.yaml
---
Shaders:
  - Stage: Vertex
    Entry: main
  - Stage: Pixel
    Entry: main
Buffers:
  - Name: VertexData
    Format: Float32
    Stride: 16
    Data: [  0.0,  3.0, 0.0, 1.0,
             3.0, -3.0, 0.0, 1.0,
            -3.0, -3.0, 0.0, 1.0 ]
  - Name: Output
    Format: Float32
    Channels: 4
    FillSize: 16 # 1x1 @ 16 bytes per pixel
    OutputProps:
      Height: 1
      Width: 1
      Depth: 1
  - Name: ResultBuffer
    Format: Float32
    FillSize: 28
    FillValue: 0.0
  - Name: ResultBuffer_Expected
    Format: Float32
    Data: [ 1, 2, 3, 4, 5, 6, 7 ]
Bindings:
  VertexBuffer: VertexData
  VertexAttributes:
    - Format: Float32
      Channels: 4
      Offset: 0
      Name: POSITION
  RenderTarget: Output
DescriptorSets:
  - Resources:
    - Name: ResultBuffer
      Kind: RWStructuredBuffer
      DirectXBinding:
        Register: 0
        Space: 0
      VulkanBinding:
        Binding: 0
Results:
  - Result: Results
    Rule: BufferExact
    Actual: ResultBuffer
    Expected: ResultBuffer_Expected
...
#--- end

# Semantics are not implemented in the DXIL backend.
# XFAIL: Clang && !Vulkan

# See https://github.com/llvm/offload-test-suite/issues/744
# XFAIL: Metal

# RUN: split-file %s %t
# RUN: %dxc_target -T vs_6_0 -Fo %t-vertex.o %t/vertex.hlsl
# RUN: %dxc_target -T ps_6_0 -Fo %t-pixel.o %t/pixel.hlsl
# RUN: %offloader %t/pipeline.yaml %t-vertex.o %t-pixel.o
