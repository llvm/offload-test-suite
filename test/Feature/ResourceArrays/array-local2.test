#--- source.hlsl

// Another variation testing resource arrays used as a local variable and
// function argument. In this case the function SomeFn modifies the array B,
// which should be a local copy of array A that is defined in main function.
// The test verifies that this modification of local array B does not affect
// array A.

RWBuffer<int> X : register(u0);
RWBuffer<int> Y : register(u1);

void SomeFn(RWBuffer<int> B[2], uint Idx, int Val0) {
  B[0] = Y;
  B[0][Idx] = Val0;
}

[numthreads(4,1,1)]
void main(uint GI : SV_GroupIndex) {
  RWBuffer<int> A[2] = {X, Y};
  SomeFn(A, GI, 1);
  A[0][GI] = 2;
}

//--- pipeline.yaml
---
Shaders:
  - Stage: Compute
    Entry: main
    DispatchSize: [1, 1, 1]
Buffers:
  - Name: BufX
    Format: Int32
    ZeroInitSize: 16

  - Name: BufY
    Format: Int32
    ZeroInitSize: 16

  - Name: ExpectedX
    Format: Int32
    Data: [ 2, 2, 2, 2 ]

  - Name: ExpectedY
    Format: Int32
    Data: [ 1, 1, 1, 1 ]

Results:
  - Result: BufX
    Rule: BufferExact
    Actual: BufX
    Expected: ExpectedX

  - Result: BufY
    Rule: BufferExact
    Actual: BufY
    Expected: ExpectedY

DescriptorSets:
  - Resources:
    - Name: BufX
      Kind: RWBuffer
      DirectXBinding:
        Register: 0
        Space: 0
      VulkanBinding:
        Binding: 0
    - Name: BufY
      Kind: RWBuffer
      DirectXBinding:
        Register: 1
        Space: 0
      VulkanBinding:
        Binding: 1
...
#--- end

# DXC-DirectX has a bug here because it does not create a local copy
# of a function argument if the type is resource or resource array.
https://github.com/microsoft/DirectXShaderCompiler/issues/7678
# XFAIL: DXC-DirectX

# Resource arrays are not yet supported on Metal
# UNSUPPORTED: Metal

# https://github.com/llvm/llvm-project/issues/154669
# XFAIL: Clang-Vulkan

# RUN: split-file %s %t
# RUN: %if !Vulkan %{ %dxc_target -T cs_6_0 -Fo %t.o %t/source.hlsl %}
# RUN: %if Vulkan %{ %dxc_target -T cs_6_0 -fspv-target-env=vulkan1.3 -Fo %t.o %t/source.hlsl %}
# RUN: %offloader %t/pipeline.yaml %t.o
